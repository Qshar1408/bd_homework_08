# Домашнее задание к занятию «Резервное копирование баз данных»
#### Грибанов Антон. FOPS-31

### Задание 1. Резервное копирование

### Кейс
Финансовая компания решила увеличить надёжность работы баз данных и их резервного копирования. 

Необходимо описать, какие варианты резервного копирования подходят в случаях: 

1.1. Необходимо восстанавливать данные в полном объёме за предыдущий день.

1.2. Необходимо восстанавливать данные за час до предполагаемой поломки.

1.3.* Возможен ли кейс, когда при поломке базы происходило моментальное переключение на работающую или починенную базу данных.

*Приведите ответ в свободной форме.*

#### Решение:

1.1. Необходимо восстанавливать данные в полном объёме за предыдущий день.
   * Подойдут варианты инкрементального или дифференциального резервного копирования, где инкрементальные или дифференциальные копии выполняются каждый день в ночное не рабочее время. На время выполнения резервного копирования БД останавливается. Если такой останов БД не возможен, то копирование файлов БД можно выполнить через snapshot файловой системы.

1.2. Необходимо восстанавливать данные за час до предполагаемой поломки.
   * Если данных не много и интенсивность использования низкая, то полное резервное копирование каждый день с дифференциальным бэкапом каждый час. Этот вариант надежнее, но использует больше места для хранения.
   * Если данных много и интенсивность использования высокая, то полное резервное копирование каждый день с инкрементным бэкапом каждый час. Этот вариант менее надежный, но использует меньше места для хранения.

1.3.* Возможен ли кейс, когда при поломке базы происходило моментальное переключение на работающую или починенную базу данных.

   * Да, возможен. Репликация. В случае поломки БД и краха Master-сервера можно назначить «новый Master-сервер» на один из Slave-серверов и перенаправить клиентов на него. После устранения неисправностей делается обратное переназначение и перенаправление.

---

### Задание 2. PostgreSQL

2.1. С помощью официальной документации приведите пример команды резервирования данных и восстановления БД (pgdump/pgrestore).

2.1.* Возможно ли автоматизировать этот процесс? Если да, то как?

*Приведите ответ в свободной форме.*

---

#### Решение:

   2.1. С помощью официальной документации приведите пример команды резервирования данных и восстановления БД (pgdump/pgrestore).
   1. Команда резервирования данных:
```bash
pg_dump sakila > sakiladb.sql
```
   2. Если нужен другой формат, то указываем параметр -Fc:
```bash
pg_dump -Fc sakila > sakiladb.dump
```
   3. Если БД принадлежит другому пользователю, то указываем параметр -U username: 
```bash
pg_dump -U username sakila > sakiladb.sql
```
   4. Команда восстановления БД:
```bash
pg_restore -d sakila sakiladb.sql
```

   2.2. Возможно ли автоматизировать этот процесс? Если да, то как?
Автоматизировать процесс резервирования данных можно,к примеру, с использованием планировщика cron. Сохраняем скрипт в файл, например, postgres_dump.sh. Для запуска резервного копирования по расписанию создаем задание в планировщике с запуском скрипта каждый день в 01:00 :
```bash
crontab -e

   1 0 * * * /scripts/postgres_dump.sh
```

### Задание 3. MySQL

3.1. С помощью официальной документации приведите пример команды инкрементного резервного копирования базы данных MySQL. 

```bash
#Команда создания полной резервнной копии всех БД, очистка двоичных журналов MySQL в момент полной резервной копии и удаление старых двоичных журналов.
#Чтобы создавать инкрементные резервные копии, нам нужно сохранить инкрементные изменения.
#В MySQL эти изменения представлены в двоичном журнале, поэтому сервер MySQL всегда следует запускать с --log-bin опцией для включения этого журнала.
mysqldump --all-databases --master-data=2 --single-transaction --flush-logs --delete-master-logs > full_backup_all_db.sql

#Команда восстановления БД из полной резервной копии :
mysql < full_backup_all_db.sql

#Команда восстановления БД из инкрементной резервной копии (двоичных журналов) :
mysqlbinlog gbichot2-bin.000008 gbichot2-bin.000009 | mysql
```
